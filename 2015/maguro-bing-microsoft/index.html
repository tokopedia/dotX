<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Starting-up within Microsoft: Maguro</title> <meta name="description" content=""> <link rel="stylesheet" href="/dotX/assets/css/main.css"> <link rel="canonical" href="http://tokopedia.github.io/dotX/2015/maguro-bing-microsoft/"> <link rel="alternate" type="application/rss+xml" title="Tokopedia Engineering" href="http://tokopedia.github.io/dotX/feed.xml"> <script src="/dotX/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Tokopedia</h2> <nav> <ul class="primary-nav"> <li><a href="/dotX/">Home</a></li> <li><a href="/dotX/blog">Blog</a></li> <li><a href="/dotX/about">Careers</a></li> <li><a href="http://github.com/tokopedia" target="_blank"><i class="icon icon-github"></i> Github</a></li> <li><a href="http://twitter.com/tokopedia" target="_blank"><i class="icon icon-twitter"></i> Twitter</a></li> <li><a href="/dotX/feed.xml" target="_blank"><i class="icon icon-feed"></i> RSS</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">Starting-up within Microsoft: Maguro</h1> <p class="post-meta"><time datetime="2015-10-06T15:20:22+07:00" itemprop="datePublished">Oct 6, 2015</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Henry Tan</span></span></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <iframe src="https://docs.google.com/presentation/d/14x8kWwWA7_bdQBaE0IfBv9OpbiYfMAAkQdVXDcEfurg/embed?start=false&amp;loop=false&amp;delayms=3000" width="640" height="389" frameborder="0" allowfullscreen="allowfullscreen"></iframe> <p><br /></p> <h4 id="you-might-be-thinking-what-does-starting-up-within-microsoft-mean">You might be thinking, what does “<em>Starting-up within Microsoft</em>” mean?</h4> <p>Though it is not very common, at <a href="http://www.microsoft.com/">Microsoft</a> we occasionally incubate products or technologies from a ground-up. Typically at any group at Microsoft we do have <em>short-term</em>, <em>mid-term</em> and <em>long-term</em> focus. Incubation of new technologies can happen for different focuses and needs and mostly they are considered as <em>long-term bets</em>.</p> <h3 id="maguro--the-big-tuna">Maguro ~ The Big Tuna</h3> <p><img src="/dotX/assets/img/upload/tuna.jpg" alt="Big Tuna" /> <span class="img-caption">Source: <a href="http://channel.nationalgeographic.com/wicked-tuna/articles/bluefin-tuna-101/">nationalgeographic.com</a></span></p> <p>Maguro means tuna in Japanese language. But, why we incubated Maguro? We were not <a href="https://www.google.com/">Google</a>, our index was only a fraction of what Google had in 2010, and we did not have as big of a budget as Google.</p> <p>We realized that one way to stay alive is to increase our index size, so our goal was to scale our index size from low to high <em>tens of Billion Documents</em> with technology that can support up to <em>1 Trillion documents</em>.</p> <p>Using the current architecture, then, was not financially feasible as it will be too expensive, besides it will hit a perf bottleneck at that scale. Hence we incubated Maguro, a system for efficiently searching very large collections of text content of up to 1 trillion documents at low cost.</p> <h3 id="search-engine">Search Engine</h3> <p><img src="/dotX/assets/img/upload/maguro-1.png" alt="Search engine (single box)" /> <span class="img-caption">Search engine (single box)</span></p> <p>Imagine a single server Search Engine, if each document (forward index unit) and reverse index can be compressed to about says 1kb – with 32GBytes of memory roughly you can hold 32Millions of documents. There are trillions of web documents on the Internet, mathematically roughly 35,000 servers for one copy of index, for about 500-1000 QPS, for 20-30K QPS, means for the capacity you will need 30-60 x 35,000 = 1M – 2M servers. $1-4Bn investment!</p> <p>With Maguro we aim to at least build the system with the investment requirement of 1/10th of conventional architecture. We aim to put up to 100M or more docs per node ~ 4Bn docs per segment ~ and let’s say hypothetically the segment size is around 40 nodes; it requires 250 segments for 1Trillion web documents. With 10K machines per capacity unit (serving row) and assume the traffics requires us to build 10 capacity rows; it requires roughly 100K machines roughly 1/10th of the capacity required without Maguro technology.</p> <h3 id="head-vs-tail">Head vs Tail</h3> <p><img src="/dotX/assets/img/upload/maguro-2.jpg" alt="Head vs long tail keywords" /> <span class="img-caption">Source: <a href="http://neilpatel.com/2015/03/26/how-to-generate-20000-monthly-search-visitors-through-long-tail-traffic/">neilpatel.com</a></span></p> <p>We make money from head contents, but we retain customers from tail contents. If customers search for something that is not in index, since switching cost is virtually zero, they can jump right away. The irony is that the cost to hold up tail contents is way too high.</p> <p>The web content distribution follows the Power law distribution, where a relative change in one quantity results in a proportional relative change in the other quantity, independent of the initial size of those quantities: one quantity varies as a power of another. <a href="#ref-1">[1]</a></p> <p>When resource is limited, it means you need strategy. In statistics, a long tail of some distributions is the portion of the distribution having a large number of occurrences far from the “head” or central part of the distribution. This insight gives you some hints the needs for a different treatment of the web contents.</p> <p>With such insight that the web content is mostly skewed towards the tail content, we can devise a strategy <em>where the existing system can be used to serve the head content and focus on the solution targeting the long tail content</em>. Hence we incubated Maguro for the long tail of content with less dynamics and less metadata, but very good cost efficiency.</p> <h3 id="doc-shard-architecture">Doc Shard Architecture</h3> <p><img src="/dotX/assets/img/upload/maguro-3.png" alt="Search engine architecture (doc shard)" /> <span class="img-caption">Search engine architecture (doc shard)</span></p> <p>Typical search engine architecture is a grid like architecture.</p> <p><img src="/dotX/assets/img/upload/maguro-4.png" alt="Doc shard (complete answer)" /> <span class="img-caption">Doc shard (complete answer)</span></p> <p>To obtain a complete answer, you send query to each of the node of each column and load-balance them to form a complete row.</p> <p><img src="/dotX/assets/img/upload/maguro-5.png" alt="Doc shard (full row)" /> <span class="img-caption">Doc shard (full row)</span></p> <p>From a full row you will get the complete results.</p> <p><img src="/dotX/assets/img/upload/maguro-6.png" alt="Grid architecture" /> <span class="img-caption">Grid architecture</span></p> <p>With grid architecture we can increase our index size simply by expanding the number of columns and increase our capacity through adding more rows. The issue of this architecture is when one row is down for maintenance, the rest of the rows are serving the traffics. You don’t want that to happen, you want to have enough rows to keep up with the loads.</p> <p>The capacity of each node with conventional architecture is fairly limited ~ 32 Millions web documents. How do we increase the capacity of a single node?</p> <h3 id="term-shard-architecture">Term Shard Architecture</h3> <p><img src="/dotX/assets/img/upload/maguro-7.png" alt="Nodes" /> <span class="img-caption">Nodes</span></p> <p><img src="/dotX/assets/img/upload/maguro-8.png" alt="Segment" /> <span class="img-caption">Segment</span></p> <p>The approach to increase the capacity of a single node is to replace the single node with a cluster of nodes, we call this node now a “<em>segment</em>“. Inside of the segment each node will work in collaboration to answer a query. This should solve the capacity problem, but new challenges arises:</p> <ol> <li><em>Query execution becomes distributed</em>, some terms might be on one node and some other terms on different nodes. So how do you do intersects or union in distributed fashion?</li> <li><em>Transferring data over the network becomes bottleneck!</em> Hence the needs for at least 10Gbps network. Some of the other techniques we do to help solve the data transfer over the network is by combining multiple words into single word and doing the processing offline. So imagine the query “<em>william tanuwijaya</em>“, instead of thinking of the query as two words, let’s think of it as a single word and it will result in shorter list and max 250ms query execution latency.</li> </ol> <p><img src="/dotX/assets/img/upload/maguro-9.png" alt="Cluster of nodes (segment)" /> <span class="img-caption">Cluster of nodes (segment)</span></p> <p>To increase the capacity per node we also enable technology to serve query from memory, SSD, or disk.</p> <p><img src="/dotX/assets/img/upload/maguro-10.png" alt="Segments" /> <span class="img-caption">Segments</span></p> <p>Now each segment represent a super node that can hold up 4Bn docs, and to serve 1 Trillion documents we will use the same grid structure as before.</p> <h3 id="maguro-architecture">Maguro architecture</h3> <p><img src="/dotX/assets/img/upload/maguro-11.png" alt="Maguro architecture" /> <span class="img-caption">Maguro architecture</span></p> <p>Instead of treating each node as a single server, each node is now a segment, with a collection of segments to be called as a cluster of nodes, a serving node with term-shard architecture.</p> <p><em>“BSDBNS: Build Simple Design but NOT Simpler”</em></p> <p><strong>Further reading:</strong> <br /> Risvik, K., Chilimbi, T., Tan, H., Kalyanaraman, K., &amp; Anderson, C. (n.d.). Maguro, a system for indexing and searching over very large text collections. <em>Proceedings of the Sixth ACM International Conference on Web Search and Data Mining – WSDM ’13</em>. Retrieved October 7, 2015, from <a href="http://dl.acm.org/citation.cfm?id=2433486">http://dl.acm.org/citation.cfm?id=2433486</a></p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/tokopedia" target="_blank"><i class="icon icon-github"></i></a></li> <li><a href="http://linkedin.com/company/1344581" target="_blank"><i class="icon icon-linkedin"></i></a></li> <li><a href="http://twitter.com/tokopedia" target="_blank"><i class="icon icon-twitter"></i></a></li> </ul> <p> <small>&copy;2016 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small> </p> </div> </footer> </main> <script src="/dotX/assets/js/jquery-2.1.1.js"></script> <script src="/dotX/assets/js/main.js"></script> </body> </html><!-- by nandomoreira.me -->